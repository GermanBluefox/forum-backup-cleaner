{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Read all files in directory /backup\r\nimport { readdirSync, unlinkSync, lstatSync } from 'node:fs';\r\nimport _config from './config.json';\r\nconst config = _config as {\r\n    directory?: string;\r\n    maxSize?: string | number;\r\n    maxDays?: number;\r\n    dryRun?: boolean;\r\n};\r\nlet path = config.directory || '/backup';\r\nif (path.endsWith('/')) {\r\n    path = path.slice(0, -1);\r\n}\r\n\r\nconfig.maxDays ||= 30;\r\nif (config.maxSize) {\r\n    if (typeof config.maxSize === 'string') {\r\n        if (config.maxSize.endsWith('MB')) {\r\n            config.maxSize = parseInt(config.maxSize.slice(0, -2), 10) * 1024 * 1024;\r\n        } else if (config.maxSize.endsWith('GB')) {\r\n            config.maxSize = parseInt(config.maxSize.slice(0, -2), 10) * 1024 * 1024 * 1024;\r\n        } else if (config.maxSize.endsWith('KB')) {\r\n            config.maxSize = parseInt(config.maxSize.slice(0, -2), 10) * 1024;\r\n        } else {\r\n            config.maxSize = parseInt(config.maxSize, 10);\r\n        }\r\n    }\r\n// Make configSize in MB\r\n    config.maxSize = Math.round(config.maxSize / (1024 * 1024));\r\n}\r\n\r\nfunction getDate(name: string): Date | null {\r\n    // nodebb-25-10-22.tar.gz\r\n    const parts = name.split('-');\r\n    if (parts.length >= 4) {\r\n        const year = 2000 + parseInt(parts[1], 10);\r\n        const month = parseInt(parts[2], 10) - 1;\r\n        const day = parseInt(parts[3].split('.')[0], 10);\r\n        return new Date(year, month, day);\r\n    }\r\n    return null;\r\n}\r\n\r\nconst list = readdirSync(path);\r\nlist.sort();\r\nlist.reverse();\r\n\r\nconst now = new Date();\r\n// delete all backups oder than 30 days\r\nlet size = 0;\r\nfor (let i = list.length - 1; i >= 0; i--) {\r\n    const file = list[i];\r\n    const date = getDate(file);\r\n    if (date) {\r\n        const diff = now.getTime() - date.getTime();\r\n        const days = diff / (3_600_000 * 24);\r\n        if (days > config.maxDays) {\r\n            console.log(`Deleting backup file: ${file} (age: ${Math.floor(days)} days) (date: ${date.toISOString().split('T')[0]})`);\r\n            if (!config.dryRun) {\r\n                unlinkSync(`${path}/${file}`);\r\n            }\r\n        }\r\n    }\r\n    const stat = lstatSync(`${path}/${file}`);\r\n    size += Math.round(stat.size / (1024 * 1024));\r\n    let deleteFollowing = false;\r\n    if (config.maxSize && (deleteFollowing || size > (config.maxSize as number))) {\r\n        console.log(`Deleting backup file: ${file} (total size exceeded: ${Math.round(size / (1024 * 1024))} MB)`);\r\n        if (!config.dryRun) {\r\n            unlinkSync(`${path}/${file}`);\r\n        }\r\n        deleteFollowing = true;\r\n    }\r\n}"]}